# JVM_黑马

## 基础篇

### 初识JVM

1. JVM是什么？

   JVM是Java虚拟机。

2. JVM功能？

   - 解释和运行：对字节码文件中的指令，实时的解释为机器码，让计算机执行
   - 内存管理：自动为对象、方法等分配内存；自动的垃圾回收机制，回收不再使用的对象
   - 即时编译：对热点代码进行优化，将解释的机器码缓存在内存中，下次运行的时候直接取出执行。

3. 常见JVM

   - HotSpot
   - GrallVM
   - Dragonwell JDK
   - J9

### 字节码文件详解

1. JVM组成部分
   - 类加载器（ClassLoader）
   - 运行时数据区域（JVM管理的内存）
   - 执行引擎（即时编译器、解释器、垃圾回收器等）
   - 本地接口（本地已经编译的方法）
2. 字节码文件的组成
   - 基础信息：魔数、字节码文件对应的Java版本号、访问表示（public 、final等）父类和接口
   - 常量池：保存了字符串常量、类或接口名、字段名主要在字节码指令中使用
   - 字段：当前类或接口声明的字段信息
   - 方法：当前类或接口声明的方法信息，字节码指令
   - JVM内存区域

**基础信息**

**魔数：**因为文件不能通过扩展名来确定文件的类型（文件后缀名可以随意的更改，不影响文件的内容），响应能够打开文件的软件会使用文件的头几个字节（文件头）去检验文件的类型，如果魔数不匹配，那么就表示当前软件不支持该种类型，那么就会报错。

**主版本号：**表示jdk的大版本，1.2之后的主版本号的计算方式就是主版本号-44。

**常量池**

作用：避免相同的内容重复定义，节省空间。

常量池中的数据都有一个编号，编号从1开始。在字段或者字节码指令中通过编号可以快速找到对应的数据。字节码指令中通过编号引用到常量池的过程称之为**符号引用**。

**方法**

```branch
iconst_0:将0放到操作数栈中
istore_1：将操作数栈中的数字移动到局部变量表数组下标为1的位置
iload_1：将局部变量数组下标为1位置上的数字复制一份放到操作数栈中
iinc 1 by 1:在局部变量表1号位置上直接增加1
```

```Java
    int i = 0,j=0,k=0;

    i++;

    j = j + 1;

    k += 1;

/*    0 iconst_0
    1 istore_1
    2 iconst_0
    3 istore_2
    4 iconst_0
    5 istore_3

    -----------------
    i++
    6 iinc 1 by 1 局部变量表1号位置直接增加1

    -----------------
    j = j + 1
    9 iload_2
    10 iconst_1
    11 iadd
    12 istore_2

    -----------------


    k += 1
    13 iinc 3 by 1
    16 return*/

    //从字节码分析，i++和k+=1都是使用的字节码指令iinc 局部变量表中的位置 by 需要直接加上的值 所以二者的运行效率是一致的
    //j = j + 1使用的是指令iload_2 iconst_1 iadd istore_2，所以运行效率较低
```

**字节码常用工具**

- Javap -v命令：是jdk自带的反编译工具，可以通过控制台查看字节码文件。

- jclasslib

- arthas

  - 监控面板

  - 查看字节码信息

  - 方法监控

  - 类的热部署

  - 内存监控

  - 垃圾回收监控

  - 应用热点定位

    **常用命令：**

    ```branch
    启动：java -jar arthas-boot.jar
    将当前字节码文件保存到指定路径:dump -d 指定路径 包名/类名
    将class文件反编译 ：jad 包名.类名
    ```

**类加载器**

- 类的生命周期
  1. 加载
     - **类加载器**根据类的权限名通过不同渠道以二进制流的方式获取字节码文件。
     - 类加载器在加载完类之后，java虚拟机会将字节码中的信息保存到方法区中。
     - 方法区中生成一个InstanceKlass对象，保存类的所有信息，里面还包含实现特定功能比如多态的信息。
     - Java虚拟机还会再堆中生成一份与方法区中数据类似的java.lang.Class对象。作用是在java代码中去获取类的信息以及存储静态字段的数据。
  2. 连接
  3. 初始化
  4. 使用
  5. 卸载



### JVM垃圾回收